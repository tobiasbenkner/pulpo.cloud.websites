---
import type { ProductCategory } from "@pulpo/cms";

interface Props {
  categories: ProductCategory[];
}
const { categories } = Astro.props;
---

<nav
  id="category-nav"
  class="sticky top-16 z-30 w-full bg-background/90 backdrop-blur-xl border-b border-white/10 shadow-lg"
>
  <div class="w-full overflow-x-auto scrollbar-hide py-3">
    <div
      class="min-w-full w-max flex justify-center"
      style="touch-action: pan-x;"
    >
      <ul class="flex items-center gap-2 px-4 md:px-0">
        {
          categories.map((category, index) => (
            <li class="shrink-0">
              <a
                href={`#${category.id}`}
                class={`category-link block px-4 py-1.5 rounded-full border transition-all duration-300 text-[10px] uppercase tracking-[0.15em] font-medium
                ${index === 0 ? "active" : ""}`}
                data-target={category.id}
              >
                {category.name}
              </a>
            </li>
          ))
        }
      </ul>
    </div>
  </div>
</nav>

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .category-link {
    background-color: rgba(255, 255, 255, 0.02);
    border-color: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.5);
    -webkit-tap-highlight-color: transparent;
  }

  .category-link:not(.active):hover {
    border-color: rgba(255, 255, 255, 0.3);
    color: white;
  }

  .category-link.active {
    background-color: rgb(253, 230, 138) !important;
    border-color: rgb(253, 230, 138) !important;
    color: black !important;
    font-weight: 700;
    box-shadow: 0 0 10px rgba(253, 230, 138, 0.2);
    transform: scale(1.02);
  }
</style>

<script>
  function initScrollSpy() {
    const navLinks = document.querySelectorAll(".category-link");
    const sections = document.querySelectorAll("section[id]");
    const navContainer = document.querySelector(".overflow-x-auto");

    const SCROLL_OFFSET = 150;

    let isClickScrolling = false;
    let clickScrollTimeout: any;

    if (sections.length === 0) return;

    navLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const targetId = link.getAttribute("href")?.substring(1);
        if (!targetId) return;

        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          isClickScrolling = true;
          if (clickScrollTimeout) clearTimeout(clickScrollTimeout);

          const top =
            targetSection.getBoundingClientRect().top +
            window.scrollY -
            SCROLL_OFFSET;

          window.scrollTo({
            top: top,
            behavior: "smooth",
          });

          setActiveLink(targetId);

          clickScrollTimeout = setTimeout(() => {
            isClickScrolling = false;
          }, 1000);
        }
      });
    });

    const observerOptions = {
      root: null,
      rootMargin: `-${SCROLL_OFFSET}px 0px -60% 0px`,
      threshold: 0,
    };

    const observer = new IntersectionObserver((entries) => {
      if (isClickScrolling) return;

      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          setActiveLink(entry.target.id);
        }
      });
    }, observerOptions);

    sections.forEach((section) => observer.observe(section));

    function setActiveLink(id: string) {
      if (!id) return;

      const currentActive = document.querySelector(".category-link.active");
      if (currentActive && currentActive.getAttribute("href") === `#${id}`) {
        return;
      }

      currentActive?.classList.remove("active");

      const activeLink = document.querySelector<HTMLElement>(
        `.category-link[href="#${id}"]`,
      );

      if (activeLink && navContainer) {
        activeLink.classList.add("active");

        const linkRect = activeLink.getBoundingClientRect();
        const containerRect = navContainer.getBoundingClientRect();

        const currentScrollLeft = navContainer.scrollLeft;
        const linkRelativeLeft = linkRect.left - containerRect.left;

        const targetScrollLeft =
          currentScrollLeft +
          linkRelativeLeft -
          navContainer.clientWidth / 2 +
          linkRect.width / 2;

        navContainer.scrollTo({
          left: targetScrollLeft,
          behavior: "smooth",
        });
      }
    }
  }

  initScrollSpy();
  document.addEventListener("astro:page-load", initScrollSpy);
</script>
