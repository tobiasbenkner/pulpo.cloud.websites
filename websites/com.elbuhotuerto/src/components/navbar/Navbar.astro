---
import { Image } from "astro:assets";
import { getTranslatedPath } from "@/lib/registry";
import { getNavbarItems } from "./getNavbarItems";
import { languages, type Language } from "@/lib/i18n";
import logo from "@/assets/logo.webp";

interface Props {
  lang: Language;
  routeKey: string;
}

const { lang, routeKey } = Astro.props;

const navItems = await getNavbarItems(lang, Astro.url.pathname);
const homeHref = getTranslatedPath("home", lang);

const flagIcons: Record<Language, string> = {
  es: "ðŸ‡ªðŸ‡¸",
  "es-ar": "ðŸ‡¦ðŸ‡·",
  de: "ðŸ‡©ðŸ‡ª",
  en: "ðŸ‡¬ðŸ‡§",
};

const labels: Record<Language, string> = {
  es: "EspaÃ±ol",
  "es-ar": "Argentino",
  de: "Deutsch",
  en: "English",
};
---

<header
  id="main-header"
  class="fixed top-0 left-0 w-full z-50 transition-colors duration-200 border-b border-white/5 bg-background/80 backdrop-blur-md"
>
  <nav class="max-w-7xl mx-auto px-6" aria-label="Top">
    <div class="flex justify-between items-center h-16">
      <div class="flex-1 flex justify-start">
        <a href={homeHref} class="group transition-opacity hover:opacity-80">
          <Image
            src={logo}
            alt="Logo"
            class="h-10 w-auto object-contain brightness-0 invert opacity-90 group-hover:opacity-100 transition-all"
          />
        </a>
      </div>

      <!-- 2. Desktop Navigation -->
      <div class="hidden md:flex flex-1 justify-center space-x-12 items-center">
        {
          navItems.map((link) => {
            return (
              <a
                href={link.href}
                class={`text-[11px] uppercase tracking-[0.2em] py-2 transition-colors duration-300
                ${link.isActive ? "text-amber-200" : "text-white/70 hover:text-amber-200"}`}
              >
                {link.label}
              </a>
            );
          })
        }
      </div>

      <!-- 3. Desktop Language Picker -->
      <div class="hidden md:flex flex-1 justify-end items-center">
        <div class="relative inline-block text-left" id="lang-dropdown-wrapper">
          <button
            type="button"
            id="lang-button"
            class="group flex items-center gap-3 focus:outline-none py-2"
          >
            <!-- Flagge (Farbig & Schatten) -->
            <span
              class="text-2xl drop-shadow-sm group-hover:scale-110 transition-transform duration-300"
            >
              {flagIcons[lang]}
            </span>
            <span
              class="h-4 w-px bg-white/10 group-hover:bg-amber-200/50 transition-colors"
            ></span>
            <svg
              class="w-3 h-3 text-white/40 group-hover:text-amber-200 transition-colors"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <!-- Desktop Dropdown -->
          <div
            id="lang-menu"
            class="hidden absolute right-0 mt-4 w-48 origin-top-right bg-[#050505]/95 backdrop-blur-xl border border-amber-200/10 shadow-2xl z-50 rounded-sm"
          >
            <div class="py-1">
              {
                languages.map((l) => (
                  <a
                    href={getTranslatedPath(routeKey, l)}
                    class="group flex items-center gap-4 px-5 py-3 hover:bg-white/5 transition-colors border-b border-white/5 last:border-0"
                  >
                    <span class="text-lg drop-shadow-sm group-hover:scale-110 transition-transform duration-300">
                      {flagIcons[l]}
                    </span>
                    <div class="flex-1 flex justify-between items-center">
                      <span
                        class={`font-serif italic text-lg ${lang === l ? "text-amber-200" : "text-gray-400 group-hover:text-white"}`}
                      >
                        {labels[l]}
                      </span>
                      {lang === l && (
                        <span class="w-1 h-1 rounded-full bg-amber-200 shadow-[0_0_8px_rgba(253,230,138,0.5)]" />
                      )}
                    </div>
                  </a>
                ))
              }
            </div>
          </div>
        </div>
      </div>

      <!-- 4. Mobile Controls -->
      <div class="md:hidden flex items-center gap-5">
        <!-- Mobile Flagge (Ã–ffnet MenÃ¼) -->
        <button
          id="mobile-lang-trigger"
          type="button"
          class="flex items-center justify-center active:scale-95 transition-transform"
          aria-label="Change Language"
        >
          <span class="text-2xl drop-shadow-md">{flagIcons[lang]}</span>
        </button>

        <!-- Burger Icon -->
        <button
          id="menu-toggle"
          type="button"
          class="p-1 text-white/80 hover:text-amber-200 transition-colors focus:outline-none"
          aria-label="Menu"
        >
          <svg
            id="menu-icon"
            class="h-7 w-7"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1"
              d="M4 8h16M4 16h16"></path>
          </svg>
          <svg
            id="close-icon"
            class="h-7 w-7 hidden"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu Overlay (Keine Animation, nur hidden Toggle) -->
    <div
      id="mobile-menu"
      class="hidden md:hidden fixed inset-0 top-16 bg-background z-40 overflow-y-auto"
    >
      <div
        class="flex flex-col items-center justify-center min-h-[60vh] space-y-8 p-6"
      >
        <nav class="flex flex-col items-center space-y-6 w-full">
          {
            navItems.map((link) => {
              return (
                <a
                  href={link.href}
                  class={`text-2xl font-serif italic transition-colors 
                  ${link.isActive ? "text-amber-200" : "text-white/80 hover:text-amber-200"}`}
                >
                  {link.label}
                </a>
              );
            })
          }
        </nav>

        <div class="w-12 h-px bg-white/10"></div>

        <div class="grid grid-cols-3 gap-6">
          {
            languages.map((l) => (
              <a
                href={getTranslatedPath(routeKey, l)}
                class={`flex flex-col items-center gap-2 p-3 rounded-md transition-all border border-transparent
                ${lang === l ? "border-amber-200/20 bg-white/5" : "text-gray-500"}`}
              >
                <span class="text-3xl drop-shadow-md">{flagIcons[l]}</span>
                <span
                  class={`text-[10px] uppercase tracking-widest ${lang === l ? "text-amber-200" : "text-white/50"}`}
                >
                  {l}
                </span>
              </a>
            ))
          }
        </div>
      </div>
    </div>
  </nav>
</header>

<script>
  const menuToggle = document.getElementById("menu-toggle");
  const mobileLangTrigger = document.getElementById("mobile-lang-trigger");
  const mobileMenu = document.getElementById("mobile-menu");
  const menuIcon = document.getElementById("menu-icon");
  const closeIcon = document.getElementById("close-icon");
  const header = document.getElementById("main-header");
  const langButton = document.getElementById("lang-button");
  const langMenu = document.getElementById("lang-menu");
  const body = document.body;

  function toggleMobileMenu() {
    const isHidden = mobileMenu?.classList.contains("hidden");

    if (isHidden) {
      // --- Ã–FFNEN ---

      // MenÃ¼ anzeigen
      mobileMenu?.classList.remove("hidden");
      menuIcon?.classList.add("hidden");
      closeIcon?.classList.remove("hidden");

      // Scrollen deaktivieren
      body.style.overflow = "hidden";

      header?.classList.remove(
        "bg-background/80",
        "backdrop-blur-md",
        "border-white/5",
      );
      header?.classList.add("bg-black", "border-transparent");
    } else {
      // --- SCHLIESSEN ---

      // MenÃ¼ ausblenden
      mobileMenu?.classList.add("hidden");
      menuIcon?.classList.remove("hidden");
      closeIcon?.classList.add("hidden");
      body.style.overflow = "";

      header?.classList.add(
        "bg-background/80",
        "backdrop-blur-md",
        "border-white/5",
      );
      header?.classList.remove("bg-black", "border-transparent");
    }
  }

  // Event Listener
  menuToggle?.addEventListener("click", (e) => {
    e.stopPropagation();
    toggleMobileMenu();
  });

  mobileLangTrigger?.addEventListener("click", (e) => {
    e.stopPropagation();
    toggleMobileMenu();
  });

  langButton?.addEventListener("click", (e) => {
    e.stopPropagation();
    langMenu?.classList.toggle("hidden");
  });

  document.addEventListener("click", (event) => {
    const target = event.target as Node;

    if (!langButton?.contains(target) && !langMenu?.contains(target)) {
      langMenu?.classList.add("hidden");
    }

    if (
      !mobileMenu?.classList.contains("hidden") &&
      !menuToggle?.contains(target) &&
      !mobileLangTrigger?.contains(target) &&
      !mobileMenu?.contains(target) &&
      !header?.contains(target)
    ) {
      toggleMobileMenu();
    }
  });

  window.addEventListener("resize", () => {
    if (window.innerWidth >= 768 && !mobileMenu?.classList.contains("hidden")) {
      toggleMobileMenu();
    }
  });
</script>
