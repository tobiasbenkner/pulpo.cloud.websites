---
import Layout from "../../layouts/Layout.astro";
import {
  languages,
  defaultLang,
  openGraphLocales,
  type Language,
} from "../../lib/i18n";
import { routeSlugs, getView, getTranslatedPath } from "../../lib/registry";

export async function getStaticPaths() {
  const paths = [];

  for (const routeKey of Object.keys(routeSlugs)) {
    const slugs = routeSlugs[routeKey];

    for (const lang of languages) {
      const slug = slugs[lang];
      const isDefault = lang === defaultLang;

      // Build alternate links for hreflang
      const alternateLinks: Record<string, string> = {};
      for (const l of languages) {
        alternateLinks[l] = getTranslatedPath(routeKey, l);
      }

      if (isDefault) {
        paths.push({
          params: { slug: slug || undefined },
          props: { routeKey, lang, alternateLinks },
        });
      } else {
        paths.push({
          params: { slug: slug ? `${lang}/${slug}` : lang },
          props: { routeKey, lang, alternateLinks },
        });
      }
    }
  }

  return paths;
}

interface Props {
  routeKey: string;
  lang: Language;
  alternateLinks: Record<string, string>;
}

const { routeKey, lang, alternateLinks } = Astro.props;

const view = getView(routeKey, lang);

if (!view) {
  return Astro.redirect("/404");
}

const { Component, t } = view;

const title = t.seo?.title ?? t.navigationLabel ?? routeKey;
const description = t.seo?.description ?? "";

// Build language objects for Layout compatibility
const languageObjects = languages.map((code) => ({
  code,
  name: code,
  flag: "",
}));
const currentLangObj = { code: lang, name: lang, flag: "" };
---

<Layout title={title} description={description} lang={lang} routeKey={routeKey}>
  <Component lang={lang} t={t} />
</Layout>
