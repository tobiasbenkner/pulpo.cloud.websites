---
import Container from "@/components/ui/Container.astro";
import LanguageSwitcher from "@/components/LanguageSwitcher.astro";
import { getNavbarItems } from "@/lib/navbar";
import { getTranslatedPath } from "@/lib/registry";
import type { Language } from "@/lib/i18n";
import { Image } from "astro:assets";
import logo from "../assets/logo.png";
import { siteData } from "@/data/siteData";

interface Props {
  lang: Language;
  routeKey: string;
}
const { lang, routeKey } = Astro.props;

const navItems = await getNavbarItems(lang, Astro.url.pathname);
const homeHref = getTranslatedPath("home", lang);
---

<header
  class="fixed top-0 left-0 z-50 w-full border-b border-border/50 bg-background/90 backdrop-blur-md"
>
  <Container>
    <div class="flex h-16 md:h-20 items-center justify-between">
      <!-- Logo -->
      <a
        href={homeHref}
        class="relative z-50 flex items-center gap-2 md:gap-3 text-lg md:text-xl font-bold font-serif text-primary"
      >
        <Image src={logo} alt="Logo" class="w-7 md:w-8 h-7 md:h-8" />
        <span>{siteData.meta.name}</span>
      </a>

      <!-- Desktop Nav -->
      <nav
        class="hidden md:flex items-center gap-4 lg:gap-6 text-sm font-medium"
      >
        {
          navItems.map((item) => {
            return (
              <a
                href={item.href}
                class:list={[
                  "transition-colors duration-200",
                  item.isActive
                    ? "text-secondary font-bold"
                    : "text-text-muted hover:text-primary",
                ]}
              >
                {item.label}
              </a>
            );
          })
        }
      </nav>

      <!-- Desktop Language Switcher -->
      <div class="hidden md:flex items-center gap-4">
        <LanguageSwitcher lang={lang} routeKey={routeKey} />
      </div>

      <!-- Mobile Menu Toggle Button -->
      <button
        id="menu-toggle"
        aria-label="Toggle Menu"
        class="relative z-50 flex flex-col justify-center gap-1.5 p-2 md:hidden group"
      >
        <span
          class="h-0.5 w-5 md:w-6 bg-white transition-all duration-300 group-data-open:rotate-45 group-data-open:translate-y-2"
        ></span>
        <span
          class="h-0.5 w-5 md:w-6 bg-white transition-all duration-300 group-data-open:opacity-0"
        ></span>
        <span
          class="h-0.5 w-5 md:w-6 bg-white transition-all duration-300 group-data-open:-rotate-45 group-data-open:-translate-y-2"
        ></span>
      </button>
    </div>
  </Container>

  <!--
    Mobile Menu Overlay
  -->
  <div
    id="mobile-menu"
    class="fixed inset-0 z-40 flex flex-col items-center justify-start w-screen h-dvh bg-background transition-all duration-300 translate-x-full opacity-0 invisible md:hidden pt-24 sm:pt-28 overscroll-contain"
  >
    <!-- Nav Container: Erlaubt Scrollen im Menü, falls das Handy sehr klein ist -->
    <nav
      class="flex flex-col items-center gap-4 sm:gap-6 text-center w-full px-6 overflow-y-auto max-h-[70vh]"
    >
      {
        navItems.map((item) => (
          <a
            href={item.href}
            class:list={[
              "text-2xl sm:text-3xl font-serif transition-colors duration-300 mobile-link w-full py-3 sm:py-4 border-b border-white/5",
              item.isActive
                ? "text-secondary"
                : "text-text-muted hover:text-white",
            ]}
          >
            {item.label}
          </a>
        ))
      }
    </nav>

    <!-- Language Switcher Mobile -->
    <div
      class="mt-6 sm:mt-8 scale-110 sm:scale-125 p-3 sm:p-4 rounded-full bg-surface/50"
    >
      <LanguageSwitcher lang={lang} routeKey={routeKey} />
    </div>
  </div>
</header>

<script>
  const menuToggle = document.getElementById("menu-toggle");
  const mobileMenu = document.getElementById("mobile-menu");
  const mobileLinks = document.querySelectorAll(".mobile-link");
  const body = document.body;
  const html = document.documentElement;

  let isOpen = false;

  function toggleMenu() {
    isOpen = !isOpen;

    if (isOpen) {
      // --- ÖFFNEN ---
      menuToggle?.setAttribute("data-open", "");
      mobileMenu?.classList.remove("invisible");

      requestAnimationFrame(() => {
        mobileMenu?.classList.remove("translate-x-full", "opacity-0");
        mobileMenu?.classList.add("translate-x-0", "opacity-100");
      });

      // Hardcore Scroll Lock (Body & HTML)
      body.style.overflow = "hidden";
      html.style.overflow = "hidden";
    } else {
      // --- SCHLIEßEN ---
      menuToggle?.removeAttribute("data-open");

      mobileMenu?.classList.add("translate-x-full", "opacity-0");
      mobileMenu?.classList.remove("translate-x-0", "opacity-100");

      // Scroll Lock aufheben
      body.style.overflow = "";
      html.style.overflow = "";
    }
  }

  // Warten bis Animation fertig ist, dann invisible setzen
  mobileMenu?.addEventListener("transitionend", () => {
    if (!isOpen) {
      mobileMenu.classList.add("invisible");
    }
  });

  menuToggle?.addEventListener("click", toggleMenu);

  mobileLinks.forEach((link) => {
    link.addEventListener("click", () => {
      if (isOpen) toggleMenu();
    });
  });

  window.addEventListener("resize", () => {
    if (window.innerWidth >= 768 && isOpen) {
      toggleMenu();
    }
  });
</script>
