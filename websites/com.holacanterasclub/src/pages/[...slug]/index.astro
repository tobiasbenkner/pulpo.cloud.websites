---
import { languages, defaultLang } from "@/lib/i18n";
import { routeSlugs, getView } from "@/lib/registry";
import Layout from "@/layouts/Layout.astro";
import { siteData } from "@/data/siteData";

export async function getStaticPaths() {
  const paths: any[] = [];
  const allRouteKeys = Object.keys(routeSlugs).concat("home");

  // 1. Statische Seiten generieren
  allRouteKeys.forEach((routeKey) => {
    // wird in anderer loop erzeugt
    if (routeKey.startsWith("blog_")) return;

    languages.forEach((lang) => {
      let slugParam: string | undefined;
      const isDefaultLang = lang === defaultLang;

      if (routeKey === "home") {
        slugParam = isDefaultLang ? undefined : lang;
      } else {
        const slugs = routeSlugs[routeKey];
        if (!slugs) return;
        const pageSlug = slugs[lang];
        if (pageSlug) {
          slugParam = isDefaultLang ? pageSlug : `${lang}/${pageSlug}`;
        }
      }

      paths.push({
        params: { slug: slugParam },
        props: { lang, routeKey },
      });
    });
  });

  return paths;
}

const { lang, routeKey, post } = Astro.props;

const view = getView(routeKey, lang);
if (!view) {
  return Astro.redirect("/404");
}

const { Component, t } = view;

// SEO Daten vorbereiten
let title = t.seo?.title || siteData.meta.name;
let description = t.seo?.description || "";

// Wenn es ein Blog Post ist, Ã¼berschreiben wir SEO mit Post-Daten
if (post && post.translations[0]) {
  title = `${post.translations[0].title} | ${siteData.meta.name}`;
  description = post.translations[0].excerpt || "";
}
---

<Layout title={title} description={description} lang={lang} routeKey={routeKey}>
  <Component lang={lang} t={t} post={post} />
</Layout>
