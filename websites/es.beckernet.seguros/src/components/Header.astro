---
import Container from "@/components/ui/Container.astro";
import LanguageSwitcher from "@/components/LanguageSwitcher.astro";
import { getNavbarItems } from "@/lib/navbar";
import { getTranslatedPath } from "@/lib/registry";
import type { Language } from "@/lib/i18n";
import { Image } from "astro:assets";
import logo from "../assets/bib.png";
import font from "../assets/becker-insurance-broker.png";

interface Props {
  lang: Language;
  routeKey: string;
}
const { lang, routeKey } = Astro.props;

const navItems = await getNavbarItems(lang, Astro.url.pathname);
const homeHref = getTranslatedPath("home", lang);
---

<header
  class="fixed top-0 left-0 z-50 w-full border-b border-border/50 bg-background/90 backdrop-blur-md"
>
  <Container>
    <div class="flex h-16 md:h-20 items-center justify-between">
      <!-- 
         LOGO BEREICH (Gestapelt)
         Hier ist die Änderung für Logo oben / Text unten.
      -->
      <a
        href={homeHref}
        class="relative z-50 flex flex-col items-center justify-center gap-0.5"
      >
        <!-- 1. BIB Symbol (Oben) -->
        <!-- lg:h-9 sorgt für Größe auf Desktop, h-6/7 auf Mobile/Tablet -->
        <Image
          src={logo}
          alt="BIB Logo"
          class="h-7 w-auto lg:h-9 object-contain mb-0.5"
          loading="eager"
        />

        <!-- 2. Schriftzug (Unten) -->
        <!-- w-32 auf Mobile/Tablet, w-48 auf Desktop (ab 1024px) -->
        <Image
          src={font}
          alt="Becker Insurance Broker"
          class="h-auto w-32 lg:w-48 object-contain"
          loading="eager"
        />
      </a>

      <!-- 
         DESKTOP NAV
         WICHTIG: "hidden lg:flex" statt "md:flex".
         Das Menü erscheint erst ab 1024px Breite.
      -->
      <nav class="hidden lg:flex items-center gap-6 text-sm font-medium">
        {
          navItems.map((item) => {
            return (
              <a
                href={item.href}
                class:list={[
                  "transition-colors duration-200",
                  item.isActive
                    ? "text-secondary font-bold"
                    : "text-text-muted hover:text-primary",
                ]}
              >
                {item.label}
              </a>
            );
          })
        }
      </nav>

      <!-- 
         DESKTOP LANGUAGE SWITCHER 
         Ebenfalls erst ab lg (1024px) sichtbar.
      -->
      <div class="hidden lg:flex items-center gap-4">
        <LanguageSwitcher lang={lang} routeKey={routeKey} />
      </div>

      <!-- 
         MOBILE/TABLET MENU BUTTON
         WICHTIG: "lg:hidden" zeigt den Button auf Mobile UND Tablet an.
         Erst ab Desktop verschwindet er.
      -->
      <button
        id="menu-toggle"
        aria-label="Toggle Menu"
        class="relative z-50 flex flex-col justify-center gap-1.5 p-2 lg:hidden group"
      >
        <span
          class="h-0.5 w-6 bg-white transition-all duration-300 group-data-open:rotate-45 group-data-open:translate-y-2"
        ></span>
        <span
          class="h-0.5 w-6 bg-white transition-all duration-300 group-data-open:opacity-0"
        ></span>
        <span
          class="h-0.5 w-6 bg-white transition-all duration-300 group-data-open:-rotate-45 group-data-open:-translate-y-2"
        ></span>
      </button>
    </div>
  </Container>

  <!--
    MOBILE MENU OVERLAY
  -->
  <div
    id="mobile-menu"
    class="fixed inset-0 z-40 flex flex-col items-center justify-start w-screen h-dvh bg-background transition-all duration-300 translate-x-full opacity-0 invisible lg:hidden pt-24 sm:pt-28 overscroll-contain"
  >
    <!-- Nav Container -->
    <nav
      class="flex flex-col items-center gap-6 text-center w-full px-6 overflow-y-auto max-h-[70vh]"
    >
      {
        navItems.map((item) => (
          <a
            href={item.href}
            class:list={[
              "text-2xl sm:text-3xl font-serif transition-colors duration-300 mobile-link w-full py-4 border-b border-white/5",
              item.isActive
                ? "text-secondary"
                : "text-text-muted hover:text-white",
            ]}
          >
            {item.label}
          </a>
        ))
      }
    </nav>

    <!-- Language Switcher Mobile -->
    <div class="mt-8 scale-125 p-4 rounded-full bg-surface/50">
      <LanguageSwitcher lang={lang} routeKey={routeKey} />
    </div>
  </div>
</header>

<script>
  const menuToggle = document.getElementById("menu-toggle");
  const mobileMenu = document.getElementById("mobile-menu");
  const mobileLinks = document.querySelectorAll(".mobile-link");
  const body = document.body;
  const html = document.documentElement;

  let isOpen = false;

  function toggleMenu() {
    isOpen = !isOpen;

    if (isOpen) {
      // --- ÖFFNEN ---
      menuToggle?.setAttribute("data-open", "");
      mobileMenu?.classList.remove("invisible");

      requestAnimationFrame(() => {
        mobileMenu?.classList.remove("translate-x-full", "opacity-0");
        mobileMenu?.classList.add("translate-x-0", "opacity-100");
      });

      // Scroll Lock
      body.style.overflow = "hidden";
      html.style.overflow = "hidden";
    } else {
      // --- SCHLIEßEN ---
      menuToggle?.removeAttribute("data-open");

      mobileMenu?.classList.add("translate-x-full", "opacity-0");
      mobileMenu?.classList.remove("translate-x-0", "opacity-100");

      // Scroll Lock aufheben
      body.style.overflow = "";
      html.style.overflow = "";
    }
  }

  mobileMenu?.addEventListener("transitionend", () => {
    if (!isOpen) {
      mobileMenu.classList.add("invisible");
    }
  });

  menuToggle?.addEventListener("click", toggleMenu);

  mobileLinks.forEach((link) => {
    link.addEventListener("click", () => {
      if (isOpen) toggleMenu();
    });
  });

  // WICHTIG: Resize Event auf 1024px angepasst (lg breakpoint)
  window.addEventListener("resize", () => {
    if (window.innerWidth >= 1024 && isOpen) {
      toggleMenu();
    }
  });
</script>
