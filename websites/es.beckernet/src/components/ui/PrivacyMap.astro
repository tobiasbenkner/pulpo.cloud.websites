---
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";
import previewImage from "../../assets/map-preview.png";

interface Props {
  url: string;
  height?: string;
  loadMap?: string;
  accept?: string;
  showMap?: string;
}

const {
  url,
  height = "h-full",
  loadMap = "Cargar mapa",
  accept = "Al hacer clic, usted acepta la transferencia de datos a Google. Guardamos esta configuraci√≥n para su visita.",
  showMap = "Mostrar mapa",
} = Astro.props;
---

<div
  class={`w-full relative bg-surface group overflow-hidden privacy-map-wrapper ${height}`}
>
  <div
    class="privacy-map-placeholder absolute inset-0 transition-opacity duration-500 z-10 overflow-hidden flex items-center justify-center"
  >
    <div class="absolute inset-0 overflow-hidden">
      <Image
        src={previewImage}
        alt="Karten-Vorschau"
        class="w-full h-full object-cover blur-[2px] scale-105 transition-transform duration-[2s]"
        loading="eager"
        quality={80}
        widths={[400, 800, 1200]}
        sizes="100vw"
      />
    </div>

    <div class="absolute inset-0 bg-black/40"></div>

    <!-- Inhalt -->
    <div
      class="relative z-10 bg-surface/95 backdrop-blur-md p-5 md:p-6 lg:p-8 rounded-lg shadow-2xl text-center max-w-sm mx-4 border border-border"
    >
      <div
        class="w-12 h-12 md:w-14 md:h-14 bg-secondary/20 rounded-full flex items-center justify-center mx-auto mb-3 md:mb-4 text-secondary"
      >
        <Icon name="lucide:map-pin" class="w-5 md:w-6 h-5 md:h-6" />
      </div>
      <h3 class="text-lg md:text-xl lg:text-2xl font-serif text-white mb-2 md:mb-3">{loadMap}</h3>
      <p class="text-text-muted text-xs md:text-sm mb-5 md:mb-6 leading-relaxed">
        {accept}
      </p>
      <button
        class="privacy-map-btn bg-secondary text-background font-bold py-2.5 md:py-3 px-6 md:px-8 rounded-full hover:bg-secondary/90 transition-all duration-300 shadow-lg w-full text-xs md:text-sm uppercase tracking-wider"
      >
        {showMap}
      </button>
    </div>
  </div>

  <!-- Der Iframe -->
  <iframe
    data-src={url}
    width="100%"
    height="100%"
    style="border:0;"
    allowfullscreen=""
    loading="lazy"
    class="privacy-map-iframe absolute inset-0 w-full h-full opacity-0 transition-opacity duration-1000"
  ></iframe>
</div>

<script>
  const STORAGE_KEY = "maps-consent";

  const activateMap = (wrapper: Element) => {
    const iframe = wrapper.querySelector(".privacy-map-iframe");
    const placeholder = wrapper.querySelector(".privacy-map-placeholder");

    if (iframe && placeholder) {
      const currentSrc = iframe.getAttribute("src");
      const dataSrc = iframe.getAttribute("data-src");

      if (!currentSrc && dataSrc) {
        iframe.setAttribute("src", dataSrc);

        (placeholder as HTMLElement).style.opacity = "0";
        (placeholder as HTMLElement).style.pointerEvents = "none";
        iframe.classList.remove("opacity-0");

        setTimeout(() => {
          (placeholder as HTMLElement).style.display = "none";
        }, 500);
      }
    }
  };

  const initMaps = () => {
    const allMaps = document.querySelectorAll(".privacy-map-wrapper");
    const hasConsent = localStorage.getItem(STORAGE_KEY) === "true";

    if (hasConsent) {
      allMaps.forEach((map) => activateMap(map));
    }

    allMaps.forEach((map) => {
      const btn = map.querySelector(".privacy-map-btn");
      if (btn) {
        btn.addEventListener("click", () => {
          localStorage.setItem(STORAGE_KEY, "true");
          const mapsNow = document.querySelectorAll(".privacy-map-wrapper");
          mapsNow.forEach((m) => activateMap(m));
        });
      }
    });
  };

  initMaps();
  document.addEventListener("astro:page-load", initMaps);
</script>
